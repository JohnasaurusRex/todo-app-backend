name: Deploy Backend to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          set -e

          echo "🚀 Starting backend deployment..."

          # Navigate to backend directory
          cd /var/www/todo-backend

          # Backup current state (just in case)
          echo "📦 Creating backup..."
          sudo cp .env .env.backup.$(date +%Y%m%d_%H%M%S) || true

          # Pull latest changes
          echo "📥 Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main

          # Install/update dependencies
          echo "📚 Installing dependencies..."
          composer install --optimize-autoloader --no-dev

          # Run database migrations (if any)
          echo "🗄️ Running database migrations..."
          php artisan migrate --force

          # Clear and cache configurations
          echo "🧹 Clearing caches..."
          php artisan config:clear
          php artisan cache:clear
          php artisan route:clear
          php artisan view:clear

          echo "⚡ Caching configurations..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # Fix permissions
          echo "🔒 Fixing permissions..."
          sudo chown -R $USER:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache

          # Restart Laravel service
          echo "🔄 Restarting Laravel service..."
          sudo systemctl restart laravel-todo

          # Wait for service to start
          sleep 3

          # Check if service is running
          if sudo systemctl is-active --quiet laravel-todo; then
            echo "✅ Laravel service is running"
          else
            echo "❌ Laravel service failed to start"
            sudo systemctl status laravel-todo
            exit 1
          fi

          # Test API endpoint
          echo "🧪 Testing API..."
          if curl -f -s http://127.0.0.1:8000/api/health > /dev/null; then
            echo "✅ API is responding"
          else
            echo "❌ API is not responding"
            exit 1
          fi

          echo "🎉 Backend deployment completed successfully!"

          # Show deployment info
          echo "📊 Deployment Summary:"
          echo "- Repository: todo-app-backend"
          echo "- Branch: main"
          echo "- Commit: $(git rev-parse --short HEAD)"
          echo "- Time: $(date)"
          echo "- Laravel Version: $(php artisan --version)"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Backend deployment successful!"
        else
          echo "❌ Backend deployment failed!"
        fi
